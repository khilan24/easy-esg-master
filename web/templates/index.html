<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>ã€å›½ä¿¡èµ„é… - å¼€è¨€ç•…è°ˆã€‘ESG ç ”ç©¶è¾…åŠ©å·¥å…·</title>
  <link rel="icon" type="image/png" href="/static/ç½‘é¡µlogo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --bg-elevated: #f8f9fa;
      --surface: #f0f2f5;
      --surface-hover: #e8eaed;
      --border: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.15);
      --text: #1a1a1a;
      --text-muted: #666666;
      --accent: rgb(0, 68, 119);
      --accent-hover: rgb(0, 85, 150);
      --accent-soft: rgba(0, 68, 119, 0.1);
      --success: rgb(0, 68, 119);
      --success-soft: rgba(0, 68, 119, 0.1);
      --warning: #f59e0b;
      --warning-soft: rgba(245, 158, 11, 0.1);
      --error: #ef4444;
      --error-soft: rgba(239, 68, 68, 0.1);
      --radius: 16px;
      --radius-sm: 12px;
      --font-display: "Plus Jakarta Sans", "Noto Sans SC", sans-serif;
      --font-hero: "DM Serif Display", "Noto Sans SC", serif;
      --font-body: "Noto Sans SC", "Plus Jakarta Sans", sans-serif;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      font-size: 15px;
      line-height: 1.65;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      padding: 0;
    }

    .app {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 2.5rem 3rem;
      position: relative;
    }

    /* å³ä¸Šè§’logoåŒºåŸŸ */
    .header-logos {
      position: absolute;
      top: calc(2rem + 0.9rem + 0.5rem);
      right: 2.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      z-index: 10;
      padding-top: calc((2.1rem * 1.2 - 2.1rem) / 2);
    }

    .header-logos img {
      height: 2.1rem;
      width: auto;
      object-fit: contain;
      display: block;
    }

    .header-logos .logo-divider {
      width: 1px;
      height: 1.8rem;
      background-color: var(--border-strong);
      margin: 0 0.25rem;
    }

    @media (max-width: 960px) {
      .header-logos {
        position: static;
        justify-content: flex-end;
        margin-bottom: 1rem;
      }
    }

    /* ä¸»æ“ä½œåŒºï¼šç”ŸæˆæŠ¥å‘Š | ç ”ç©¶è¿›å±•ä¸è€—æ—¶ */
    .row-primary {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-bottom: 1.25rem;
    }
    @media (min-width: 960px) {
      .row-primary {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .row-primary .progress-card { min-height: 260px; }
    }

    /* ç ”ç©¶è¿›å±•å¡ç‰‡ï¼šæ— æ•°æ®æ—¶å ä½ï¼Œé¿å…å³ä¾§ç©ºæ´ */
    .progress-card .progress-placeholder {
      padding: 1.5rem 0;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .progress-card.has-data .progress-placeholder { display: none; }
    .progress-card:not(.has-data) .progress-summary,
    .progress-card:not(.has-data) .progress-timeline { display: none; }

    /* ä¸‹è½½ç»“æœæ¨ªæ¡ */
    .download-card-fullwidth {
      margin-bottom: 1.25rem;
      width: 100%;
    }
    .download-card-fullwidth .downloads {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-start;
      margin-top: 1rem;
    }
    .download-card-fullwidth .download-group {
      flex: 1;
      min-width: 220px;
    }
    @media (max-width: 960px) {
      .download-card-fullwidth .downloads {
        flex-direction: column;
        gap: 1rem;
      }
      .download-card-fullwidth .download-group {
        min-width: 100%;
      }
    }

    /* è¾“å‡ºåŒºï¼šè¿è¡Œæ—¥å¿— | ä½¿ç”¨è¯´æ˜ */
    .app-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }
    @media (min-width: 960px) {
      .app-grid {
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        gap: 1.5rem;
      }
      .app-grid .span-full { grid-column: 1 / -1; }
      .app-grid .card { margin-bottom: 0; }
      .card-log .log-box { max-height: 380px; }
    }

    .app-side {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* å“ç‰Œä¸ä¸»æ ‡é¢˜ */
    .brand {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin-bottom: 0.5rem;
      animation: fadeUp 0.5s ease-out;
    }

    .hero h1 {
      font-family: var(--font-hero);
      font-size: 2.1rem;
      font-weight: 400;
      letter-spacing: -0.02em;
      margin: 0 0 0.75rem 0;
      color: var(--text);
      line-height: 1.2;
      animation: fadeUp 0.5s ease-out 0.05s backwards;
    }

    .hero .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin: 0 0 0 0;
      max-width: 52em;
      animation: fadeUp 0.5s ease-out 0.1s backwards;
    }

    .hero {
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
      padding-right: 200px;
    }

    @media (max-width: 960px) {
      .hero {
        padding-right: 0;
      }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.6rem 1.75rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      animation: fadeUp 0.5s ease-out backwards;
      background-color: #f5f5f5;
    }
    .row-primary .card,
    .app-grid .card { margin-bottom: 0; }

    .card:nth-of-type(1) { animation-delay: 0.08s; }
    .card:nth-of-type(2) { animation-delay: 0.14s; }
    .card:nth-of-type(3) { animation-delay: 0.2s; }
    .card:nth-of-type(4) { animation-delay: 0.26s; }
    .card:nth-of-type(5) { animation-delay: 0.32s; }
    .card:nth-of-type(6) { animation-delay: 0.38s; }

    .card:hover {
      border-color: var(--border-strong);
      box-shadow: var(--shadow-lg);
      background-color: #f0f0f0;
    }

    #configAlert {
      margin-bottom: 1.25rem;
      animation: fadeUp 0.4s ease-out;
    }

    .alert {
      padding: 0.9rem 1.1rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      border: 1px solid transparent;
    }

    .alert.warning {
      background: var(--warning-soft);
      color: var(--warning);
      border-color: rgba(251, 191, 36, 0.25);
    }

    .alert.error {
      background: var(--error-soft);
      color: var(--error);
      border-color: rgba(248, 113, 113, 0.25);
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 1rem 0;
      letter-spacing: 0.02em;
    }

    .mode-group { margin-bottom: 1.25rem; }

    .mode-label {
      display: block;
      color: var(--text-muted);
      font-size: 0.78rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.6rem;
    }

    .mode-tabs {
      display: inline-flex;
      padding: 5px;
      background: #f5f5f5;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .mode-tabs label {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .mode-tabs label:hover { color: var(--text); }

    .mode-tabs input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .mode-tabs input:checked + span {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .api-key-input {
      width: 100%;
      padding: 0.65rem 1rem;
      font-family: var(--font-body);
      font-size: 0.9rem;
      color: var(--text);
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      outline: none;
      transition: border-color 0.2s ease;
    }
    .api-key-input::placeholder {
      color: var(--text-muted);
    }
    .api-key-input:focus {
      border-color: var(--accent);
    }

    .api-keys-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.75rem;
    }
    @media (max-width: 560px) {
      .api-keys-row { grid-template-columns: 1fr; }
    }
    .api-key-item label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .api-key-item .api-key-input { width: 100%; }

    .mode-tabs label span {
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }

    .action-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1.25rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.4rem 0.85rem;
      font-size: 0.8rem;
      font-weight: 500;
      border-radius: 999px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    .status-badge::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.idle { background: #e5e5e5; color: var(--text-muted); }
    .status-badge.running { background: var(--accent-soft); color: var(--accent); }
    .status-badge.running::before { animation: pulse 1.2s ease-in-out infinite; }
    .status-badge.done { background: var(--success-soft); color: var(--success); }
    .status-badge.error { background: var(--error-soft); color: var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    #statusMessage {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      min-height: 1.4em;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem 1.6rem;
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 68, 119, 0.25);
    }

    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 68, 119, 0.35);
    }

    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .btn-cancel {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-strong);
    }
    .btn-cancel:hover:not(:disabled) {
      background: var(--error-soft);
      color: var(--error);
      border-color: var(--error);
    }

    .spinner {
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .log-box {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem 1.1rem;
      font-family: ui-monospace, "Cascadia Code", "Consolas", monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 320px;
      min-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text);
    }

    .log-box:empty::before {
      content: "æš‚æ— æ—¥å¿—";
      color: var(--text-muted);
      opacity: 0.7;
    }

    /* ç ”ç©¶è¿›å±•ä¸è€—æ—¶ */
    .progress-card { animation-delay: 0.12s; }
    .progress-summary {
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      background: #ffffff;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .progress-total-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .progress-total-value {
      font-family: var(--font-display);
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.02em;
    }
    .progress-timeline { margin-top: 0.5rem; }
    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .progress-step {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 0.85rem 0;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .progress-step:last-child { border-bottom: none; }
    .progress-step.completed {
      border-left: 3px solid var(--success);
      padding-left: 0.5rem;
      margin-left: -0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .progress-step.current {
      background: var(--accent-soft);
      border-left: 3px solid var(--accent);
      padding-left: 0.5rem;
      margin-left: -0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .progress-step.pending { opacity: 0.6; }
    .progress-step-marker {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      background: #e5e5e5;
      color: var(--text-muted);
      border: 2px solid var(--border);
    }
    .progress-step.completed .progress-step-marker {
      background: var(--success-soft);
      color: var(--success);
      border-color: var(--success);
    }
    .progress-step.current .progress-step-marker {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
      animation: pulse 1.2s ease-in-out infinite;
    }
    .progress-step.current .progress-step-marker::after {
      border-color: var(--accent);
    }
    .progress-step.current .progress-step-marker::before { content: ""; }
    .progress-step.current .progress-step-marker {
      position: relative;
    }
    .progress-step.current .progress-step-marker::after {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      opacity: 0.4;
      animation: pulse-ring 1.5s ease-out infinite;
    }
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      100% { transform: scale(1.4); opacity: 0; }
    }
    .progress-step-body { flex: 1; min-width: 0; }
    .progress-step-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      margin-bottom: 0.2rem;
    }
    .progress-step-duration {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .progress-step-duration strong { color: var(--accent); }

    .downloads {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .download-card-fullwidth .downloads {
      flex-direction: row;
      gap: 1rem;
    }

    .download-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .download-type-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .download-link {
      display: inline-flex;
      align-items: center;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--accent);
      background: var(--accent-soft);
      border: 1px solid rgba(0, 68, 119, 0.25);
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      width: fit-content;
      white-space: nowrap;
    }

    .download-link:hover {
      background: rgba(0, 68, 119, 0.15);
      color: var(--accent-hover);
      border-color: var(--accent);
    }
    
    .download-card-fullwidth .download-link {
      width: 100%;
      justify-content: center;
    }

    .download-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.75rem;
      line-height: 1.5;
    }

    .help-card {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.7;
    }

    .help-card ul {
      margin: 0.5rem 0 0 1.2rem;
      padding: 0;
    }

    .help-card li { margin-bottom: 0.35rem; }

    .footer {
      margin-top: 2.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-logos">
      <img src="/static/å›½ä¿¡logo.png" alt="å›½ä¿¡è¯åˆ¸" />
      <div class="logo-divider"></div>
      <img src="/static/å¼€è¨€logo.png" alt="å¼€è¨€ç•…è°ˆ" />
    </div>
    <header class="hero">
      <div class="brand">ã€å›½ä¿¡èµ„é… - å¼€è¨€ç•…è°ˆã€‘</div>
      <h1>ESG ç ”ç©¶è¾…åŠ©å·¥å…·</h1>
      <p class="subtitle">æ™ºèƒ½èšåˆå…¨ç½‘èµ„è®¯ï¼Œä¸€é”®ç”Ÿæˆ ESG æŠ•ç ”æ—¥æŠ¥/å‘¨æŠ¥ã€‚æ”¯æŒè‡ªåŠ¨å½’æ¡£ä¸ Word æ ¼å¼å¯¼å‡ºï¼ŒåŠ©æ‚¨é«˜æ•ˆæ•æ‰å¸‚åœºåŠ¨æ€ã€‚</p>
    </header>

    <div id="configAlert" class="alert warning" style="display: none;"></div>

    <div class="row-primary">
      <div class="card card-run">
        <h2 class="card-title">ç”ŸæˆæŠ¥å‘Š</h2>
      <div class="mode-group">
        <span class="mode-label">æ¨¡å‹ / æœåŠ¡</span>
        <div class="mode-tabs" id="providerTabs">
          <label>
            <input type="radio" name="provider" value="gemini" checked>
            <span>Gemini</span>
          </label>
          <label>
            <input type="radio" name="provider" value="qwen">
            <span>åƒé—®ï¼ˆQwenï¼‰</span>
          </label>
        </div>
      </div>
      <div class="mode-group" id="apiKeyGroupQwen">
        <span class="mode-label">åƒé—® API Key</span>
        <input type="password" id="apiKeyInput" class="api-key-input" placeholder="è¯·è¾“å…¥åƒé—® API Keyï¼ˆå¯é€‰ï¼‰" autocomplete="off">
      </div>
      <div class="mode-group" id="apiKeyGroupGemini" style="display: none;">
        <span class="mode-label">Gemini API Keyï¼ˆE / S / G å„ä¸€ä¸ªï¼Œç”¨äºå¹¶è¡Œç ”ç©¶ï¼‰</span>
        <div class="api-keys-row">
          <div class="api-key-item">
            <label for="apiKeyE">ç¯å¢ƒï¼ˆEï¼‰</label>
            <input type="password" id="apiKeyE" class="api-key-input" placeholder="E é¢†åŸŸ Key" autocomplete="off">
          </div>
          <div class="api-key-item">
            <label for="apiKeyS">ç¤¾ä¼šï¼ˆSï¼‰</label>
            <input type="password" id="apiKeyS" class="api-key-input" placeholder="S é¢†åŸŸ Key" autocomplete="off">
          </div>
          <div class="api-key-item">
            <label for="apiKeyG">æ²»ç†ï¼ˆGï¼‰</label>
            <input type="password" id="apiKeyG" class="api-key-input" placeholder="G é¢†åŸŸ Key" autocomplete="off">
          </div>
        </div>
      </div>
      <div class="mode-group">
        <span class="mode-label">æŠ¥å‘Šç±»å‹</span>
        <div class="mode-tabs">
          <label>
            <input type="radio" name="mode" value="weekly" checked>
            <span>å‘¨æŠ¥ï¼ˆä¸Šå‘¨ï¼‰</span>
          </label>
          <label>
            <input type="radio" name="mode" value="daily">
            <span>æ—¥æŠ¥ï¼ˆæ˜¨æ—¥ï¼‰</span>
          </label>
        </div>
      </div>
      <div class="action-row">
        <div id="statusBadge" class="status-badge idle">å°±ç»ª</div>
        <button id="btnRun" class="btn">ç”ŸæˆæŠ¥å‘Š</button>
        <button id="btnCancel" class="btn btn-cancel" style="display: none;">ä¸­æ­¢æœ¬æ¬¡ç”Ÿæˆ</button>
      </div>
      <p id="statusMessage"></p>
      </div>

      <div id="progressCard" class="card progress-card">
        <h2 class="card-title">ç ”ç©¶è¿›å±•ä¸è€—æ—¶</h2>
        <div class="progress-placeholder" id="progressPlaceholder">
          é€‰æ‹©æ¨¡å‹å¹¶ç‚¹å‡»ã€Œç”ŸæˆæŠ¥å‘Šã€åï¼Œæ­¤å¤„å°†æ˜¾ç¤ºç ”ç©¶é˜¶æ®µä¸è¿è¡Œè€—æ—¶ã€‚
        </div>
        <div class="progress-summary">
          <div class="progress-total">
            <span class="progress-total-label">è¿è¡Œæ€»æ—¶é•¿</span>
            <span id="totalElapsed" class="progress-total-value">â€”</span>
          </div>
        </div>
        <div class="progress-timeline">
          <div class="progress-steps" id="progressSteps"></div>
        </div>
      </div>
    </div>

    <div id="downloadCard" class="card download-card-fullwidth" style="display: none;">
      <h2 class="card-title" id="downloadTitle">ä¸‹è½½ç»“æœ</h2>
      <div id="downloads" class="downloads"></div>
      <p class="download-hint">æŠ¥å‘Šç”Ÿæˆå®Œæˆåï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ° output ç›®å½•ã€‚æ‚¨å¯ä»¥é€‰æ‹©ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶ï¼šåŸå§‹å†…å®¹ï¼ˆTXTï¼‰ã€ç»“æ„åŒ–æŠ¥å‘Šï¼ˆJSONï¼‰ã€Word æœ€ç»ˆç‰ˆï¼ˆDOCXï¼‰ã€‚</p>
    </div>

    <div class="app-grid">
      <div class="card card-log">
        <h2 class="card-title">è¿è¡Œæ—¥å¿—</h2>
        <div id="logBox" class="log-box" tabindex="0"></div>
      </div>
      <div class="app-side">
        <div class="card help-card">
          <h2 class="card-title">ä½¿ç”¨è¯´æ˜</h2>
          <ul>
            <li><strong>å‘¨æŠ¥</strong>ï¼šç ”ç©¶åŒºé—´ä¸ºä¸Šå‘¨ä¸€è‡³ä¸Šå‘¨æ—¥ï¼Œè¾“å‡ºè‡³ <code>output/weekly/</code>ã€‚</li>
            <li><strong>æ—¥æŠ¥</strong>ï¼šç ”ç©¶åŒºé—´ä¸ºæ˜¨æ—¥ï¼ˆå½“å‰æ—¥æœŸçš„å‰ä¸€å¤©ï¼‰ï¼Œè¾“å‡ºè‡³ <code>output/daily/</code>ã€‚</li>
            <li>æ¯æ¬¡ç”Ÿæˆä¼šå¾—åˆ°ä¸‰ä¸ªæ–‡ä»¶ï¼šåŸå§‹å†…å®¹ï¼ˆ.txtï¼‰ã€ç»“æ„åŒ–æŠ¥å‘Šï¼ˆ.jsonï¼‰ã€Word æœ€ç»ˆç‰ˆï¼ˆ.docxï¼‰ï¼Œæ–‡ä»¶åå‡ä»¥æ—¥æœŸå¼€å¤´ã€‚</li>
            <li>ç”Ÿæˆè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼›å®Œæˆåå¯ç›´æ¥åœ¨ä¸‹æ–¹ä¸‹è½½ï¼Œæˆ–åˆ°å¯¹åº”ç›®å½•æŸ¥çœ‹ã€‚</li>
            <li><strong>API Key</strong>ï¼šé€‰æ‹©æ¨¡å‹ååœ¨ä¸Šæ–¹è¾“å…¥ã€‚Gemini éœ€å¡«å†™ Eã€Sã€G ä¸‰ä¸ª Keyï¼ˆç”¨äºå¹¶è¡Œç ”ç©¶ï¼‰ï¼›åƒé—®åªéœ€ä¸€ä¸ªã€‚ä»…ç”¨äºå½“æ¬¡è¿è¡Œã€ä¸ä¼šä¿å­˜ã€‚</li>
            <li>ä¸ºè·å¾—æ›´ä¼˜è´¨çš„ç ”æŠ¥å†…å®¹ä¸æ·±åº¦åˆ†æï¼Œæ¨èä¼˜å…ˆä½¿ç”¨ Gemini è¿›è¡Œç ”ç©¶è¾…åŠ©ã€‚</li>
          </ul>
        </div>
      </div>
    </div>

    <footer class="footer">
      ã€å›½ä¿¡èµ„é… - å¼€è¨€ç•…è°ˆã€‘ESG ç ”ç©¶è¾…åŠ©å·¥å…· Â· å‘¨æŠ¥ / æ—¥æŠ¥ä¸€é”®ç”Ÿæˆ
    </footer>
  </div>

  <script>
    const statusBadge = document.getElementById('statusBadge');
    const statusMessage = document.getElementById('statusMessage');
    const btnRun = document.getElementById('btnRun');
    const btnCancel = document.getElementById('btnCancel');
    const logBox = document.getElementById('logBox');
    const configAlert = document.getElementById('configAlert');
    const downloadCard = document.getElementById('downloadCard');
    const downloadTitle = document.getElementById('downloadTitle');
    const downloadsEl = document.getElementById('downloads');
    const progressCard = document.getElementById('progressCard');
    const totalElapsedEl = document.getElementById('totalElapsed');
    const progressStepsEl = document.getElementById('progressSteps');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const apiKeyGroupQwen = document.getElementById('apiKeyGroupQwen');
    const apiKeyGroupGemini = document.getElementById('apiKeyGroupGemini');
    const apiKeyE = document.getElementById('apiKeyE');
    const apiKeyS = document.getElementById('apiKeyS');
    const apiKeyG = document.getElementById('apiKeyG');

    const STAGE_ORDER = [
      { id: 'stage1', label: 'å…¨ç½‘æ·±åº¦æ£€ç´¢' },
      { id: 'stage2', label: 'æ ¸å¿ƒè§‚ç‚¹æç‚¼' },
      { id: 'stage3', label: 'å¸‚åœºçƒ­ç‚¹èšç„¦' },
      { id: 'stage4', label: 'ç»¼åˆç ”æŠ¥æ±‡æ€»' },
      { id: 'stage5', label: 'æ–‡æ¡£æ’ç‰ˆç”Ÿæˆ' }
    ];

    let pollTimer = null;
    let elapsedTickTimer = null;

    function formatDuration(sec) {
      if (sec == null || isNaN(sec)) return 'â€”';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      if (m > 0) return m + ' åˆ† ' + s + ' ç§’';
      return s + ' ç§’';
    }

    function renderProgress(progress, status) {
      if (!progress) {
        progressCard.classList.remove('has-data');
        if (elapsedTickTimer) { clearInterval(elapsedTickTimer); elapsedTickTimer = null; }
        return;
      }
      progressCard.classList.add('has-data');
      const totalSec = progress.total_elapsed_sec;
      const totalStartedAt = progress.total_started_at;
      const currentStage = progress.current_stage || '';
      const completed = progress.completed_stages || [];
      const completedMap = {};
      completed.forEach(function (s) { completedMap[s.id] = s; });

      if (status === 'running' && totalStartedAt != null) {
        function updateElapsed() {
          const startMs = typeof totalStartedAt === 'number' ? totalStartedAt * 1000 : new Date(totalStartedAt).getTime();
          if (isNaN(startMs)) return;
          const sec = (Date.now() - startMs) / 1000;
          totalElapsedEl.textContent = formatDuration(sec);
        }
        updateElapsed();
        if (elapsedTickTimer) clearInterval(elapsedTickTimer);
        elapsedTickTimer = setInterval(updateElapsed, 1000);
      } else {
        if (elapsedTickTimer) { clearInterval(elapsedTickTimer); elapsedTickTimer = null; }
        totalElapsedEl.textContent = formatDuration(totalSec);
      }

      let html = '';
      STAGE_ORDER.forEach(function (s, i) {
        const isCompleted = completedMap[s.id];
        const isCurrent = currentStage === s.id;
        const isPending = !isCompleted && !isCurrent;
        let cls = 'progress-step';
        if (isCompleted) cls += ' completed';
        else if (isCurrent) cls += ' current';
        else if (isPending) cls += ' pending';
        const duration = isCompleted ? formatDuration(isCompleted.duration_sec) : '';
        const durationHtml = duration ? '<div class="progress-step-duration">è€—æ—¶ <strong>' + escapeHtml(duration) + '</strong></div>' : '';
        const markerContent = isCompleted ? 'âœ“' : (i + 1);
        html += '<div class="' + cls + '" data-stage="' + escapeHtml(s.id) + '">';
        html += '<div class="progress-step-marker">' + markerContent + '</div>';
        html += '<div class="progress-step-body"><div class="progress-step-title">' + escapeHtml(s.label) + '</div>' + durationHtml + '</div></div>';
      });
      progressStepsEl.innerHTML = html;
    }

    function clearProgressUI() {
      progressCard.classList.remove('has-data');
      if (elapsedTickTimer) { clearInterval(elapsedTickTimer); elapsedTickTimer = null; }
    }

    function setStatus(s, msg) {
      statusBadge.textContent = { idle: 'å°±ç»ª', running: 'è¿è¡Œä¸­', done: 'å®Œæˆ', error: 'å¤±è´¥' }[s] || s;
      statusBadge.className = 'status-badge ' + s;
      statusMessage.textContent = msg || '';
    }

    function showConfigAlert(ok, message) {
      if (!ok && message) {
        configAlert.textContent = message;
        configAlert.className = 'alert error';
        configAlert.style.display = 'block';
      } else {
        configAlert.style.display = 'none';
      }
    }

    async function fetchStatus() {
      try {
        const r = await fetch('/api/status');
        const d = await r.json();
        setStatus(d.status, d.message);
        if (d.log_tail && d.log_tail.length) {
          // æ¸…ç†å¯èƒ½çš„ä¹±ç å­—ç¬¦
          const cleanedLogs = d.log_tail.map(line => {
            // ç§»é™¤æ˜æ˜¾çš„ä¹±ç æ¨¡å¼ï¼ˆè¿ç»­çš„æ›¿æ¢å­—ç¬¦ï¼‰
            return line.replace(/\uFFFD+/g, '[ç¼–ç é”™è¯¯]').replace(/\u0000/g, '');
          });
          logBox.textContent = cleanedLogs.join('\n');
          logBox.scrollTop = logBox.scrollHeight;
        }
        if (d.progress) {
          renderProgress(d.progress, d.status);
        } else {
          clearProgressUI();
        }
        if (d.status === 'running') {
          btnRun.disabled = true;
          btnRun.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­â€¦';
          if (btnCancel) btnCancel.style.display = '';
          if (!pollTimer) pollTimer = setInterval(fetchStatus, 3000);
        } else {
          btnRun.disabled = false;
          btnRun.textContent = 'ç”ŸæˆæŠ¥å‘Š';
          if (btnCancel) btnCancel.style.display = 'none';
          if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
          if (elapsedTickTimer) { clearInterval(elapsedTickTimer); elapsedTickTimer = null; }
        }
        if (d.status === 'done') {
          downloadCard.style.display = 'block';
          downloadCard.style.animation = 'fadeUp 0.4s ease-out';
          const label = d.last_report_label || '';
          downloadTitle.textContent = label ? 'ä¸‹è½½ç»“æœï¼ˆ' + label + 'ï¼‰' : 'ä¸‹è½½ç»“æœ';
          
          if (d.output_files && d.output_files.length > 0) {
            // æŒ‰æ–‡ä»¶ç±»å‹åˆ†ç±»
            const filesByType = {
              txt: [],
              json: [],
              docx: []
            };
            d.output_files.forEach(f => {
              const name = f.name.toLowerCase();
              if (name.endsWith('.txt')) {
                filesByType.txt.push(f);
              } else if (name.endsWith('.json')) {
                filesByType.json.push(f);
              } else if (name.endsWith('.docx')) {
                filesByType.docx.push(f);
              }
            });
            
            // æ„å»ºä¸‹è½½é“¾æ¥HTML
            let html = '';
            if (filesByType.txt.length > 0) {
              html += '<div class="download-group"><div class="download-type-label">ğŸ“„ åŸå§‹å†…å®¹ï¼ˆTXTï¼‰</div>';
              filesByType.txt.forEach(f => {
                html += '<a href="/api/download/' + encodeURIComponent(f.path) + '" download class="download-link">' + escapeHtml(f.name) + '</a>';
              });
              html += '</div>';
            }
            if (filesByType.json.length > 0) {
              html += '<div class="download-group"><div class="download-type-label">ğŸ“Š ç»“æ„åŒ–æŠ¥å‘Šï¼ˆJSONï¼‰</div>';
              filesByType.json.forEach(f => {
                html += '<a href="/api/download/' + encodeURIComponent(f.path) + '" download class="download-link">' + escapeHtml(f.name) + '</a>';
              });
              html += '</div>';
            }
            if (filesByType.docx.length > 0) {
              html += '<div class="download-group"><div class="download-type-label">ğŸ“ Word æœ€ç»ˆç‰ˆï¼ˆDOCXï¼‰</div>';
              filesByType.docx.forEach(f => {
                html += '<a href="/api/download/' + encodeURIComponent(f.path) + '" download class="download-link">' + escapeHtml(f.name) + '</a>';
              });
              html += '</div>';
            }
            downloadsEl.innerHTML = html || '<p style="color: var(--text-muted); font-size: 0.9rem;">æœªæ‰¾åˆ°å¯ä¸‹è½½çš„æ–‡ä»¶</p>';
          } else {
            downloadsEl.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ output ç›®å½•</p>';
          }
        }
        if (d.status === 'error') {
          downloadCard.style.display = 'none';
        }
      } catch (e) {
        setStatus('error', 'è·å–çŠ¶æ€å¤±è´¥');
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        if (elapsedTickTimer) { clearInterval(elapsedTickTimer); elapsedTickTimer = null; }
        btnRun.disabled = false;
        btnRun.textContent = 'ç”ŸæˆæŠ¥å‘Š';
        if (btnCancel) btnCancel.style.display = 'none';
      }
    }

    if (btnCancel) {
      btnCancel.addEventListener('click', async () => {
        try {
          const r = await fetch('/api/cancel', { method: 'POST' });
          const d = await r.json();
          if (d.ok) {
            await fetchStatus();
          } else {
            alert(d.message || 'å–æ¶ˆå¤±è´¥');
          }
        } catch (e) {
          alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
        }
      });
    }

    function getMode() {
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : 'weekly';
    }

    function getProvider() {
      const el = document.querySelector('input[name="provider"]:checked');
      return el ? el.value : 'gemini';
    }

    function updateApiKeyUI() {
      var p = getProvider();
      if (apiKeyGroupQwen) apiKeyGroupQwen.style.display = p === 'qwen' ? 'block' : 'none';
      if (apiKeyGroupGemini) apiKeyGroupGemini.style.display = p === 'gemini' ? 'block' : 'none';
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    document.querySelectorAll('input[name="provider"]').forEach(function (radio) {
      radio.addEventListener('change', updateApiKeyUI);
    });
    updateApiKeyUI();

    btnRun.addEventListener('click', async () => {
      try {
        const mode = getMode();
        const provider = getProvider();
        var apiKey = '';
        var apiKeys = null;
        if (provider === 'qwen') {
          apiKey = (apiKeyInput && apiKeyInput.value) ? apiKeyInput.value.trim() : '';
        } else {
          var e = (apiKeyE && apiKeyE.value) ? apiKeyE.value.trim() : '';
          var s = (apiKeyS && apiKeyS.value) ? apiKeyS.value.trim() : '';
          var g = (apiKeyG && apiKeyG.value) ? apiKeyG.value.trim() : '';
          if (e || s || g) apiKeys = { E: e, S: s, G: g };
        }
        const r = await fetch('/api/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: mode, provider: provider, api_key: apiKey, api_keys: apiKeys })
        });
        const d = await r.json();
        if (!d.ok) {
          alert(d.message || 'å¯åŠ¨å¤±è´¥');
          showConfigAlert(false, d.message);
          return;
        }
        showConfigAlert(true);
        setStatus('running', d.message);
        btnRun.disabled = true;
        btnRun.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­â€¦';
        if (!pollTimer) pollTimer = setInterval(fetchStatus, 3000);
        fetchStatus();
      } catch (e) {
        alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
      }
    });

    function applyAvailableProviders(available) {
      if (!Array.isArray(available) || !available.length) return;
      const tabs = document.getElementById('providerTabs');
      if (!tabs) return;
      tabs.querySelectorAll('input[name="provider"]').forEach(function (radio) {
        const label = radio.closest('label');
        const ok = available.indexOf(radio.value) !== -1;
        radio.disabled = !ok;
        label.style.opacity = ok ? '' : '0.6';
        label.title = ok ? '' : 'è¯¥æœåŠ¡æš‚æœªé…ç½® API Key';
      });
    }

    (async () => {
      try {
        const r = await fetch('/api/config-check');
        const d = await r.json();
        showConfigAlert(d.ok, d.message);
        if (d.available_providers) applyAvailableProviders(d.available_providers);
      } catch (_) {}
      await fetchStatus();
    })();
  </script>
</body>
</html>
